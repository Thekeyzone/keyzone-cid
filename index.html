<!doctype html>
<html lang="en">
<head>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retrieve CID</title>

  <style>
    .brand{
  display:flex;
  align-items:center;
  gap:14px;
}

.logo{
  width:48px;
  height:48px;
  object-fit:contain;
  border-radius:12px;
}

.brandName{
  margin:0;
  font-size:22px;
  font-weight:800;
  letter-spacing:.3px;
  line-height:1.1;
}

.brandTag{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}

    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#d9dbe5;
      --primary:#4f46e5;
      --primary2:#4338ca;
      --success:#10b981;
      --danger:#b00020;
      --dangerBg:#ffecec;
      --soft:#f1f5ff;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --radius:14px;
      --chip:#f3f4f6;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#243047;
      --primary:#6366f1;
      --primary2:#4f46e5;
      --success:#10b981;
      --danger:#ff6b81;
      --dangerBg:#2a1217;
      --soft:#111c33;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:14px;
      --chip:#141f37;
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .wrap{max-width:760px; margin:64px auto; padding:0 18px;}
    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); overflow:hidden;
      border:1px solid rgba(255,255,255,.03);
    }
    .head{
      padding:20px 22px; border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    }
    h1{margin:0; font-size:22px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:13px;}
    .headLeft{min-width:0}
    .headRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .toggle{
      border:1px solid rgba(255,255,255,.10);
      background:transparent; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:650; font-size:13px;
    }
    .toggle:hover{background:rgba(255,255,255,.05)}

    .body{padding:22px;}
    label{display:block; font-weight:650; margin:0 0 8px;}
    textarea{
      width:100%; min-height:92px; resize:vertical;
      padding:12px 12px; border-radius:12px;
      border:1px solid var(--border); font-size:15px;
      outline:none; color:var(--text); background:transparent;
    }
    textarea:focus{border-color:#b9bdf6; box-shadow:0 0 0 4px rgba(79,70,229,.12)}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      appearance:none; border:0; border-radius:12px;
      padding:11px 14px; font-size:14px; font-weight:650;
      cursor:pointer; display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn-primary{background:var(--primary); color:white;}
    .btn-primary:hover{background:var(--primary2);}
    .btn-ghost{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid rgba(255,255,255,.10);
    }
    .btn-ghost:hover{background:rgba(255,255,255,.10);}
    .btn-success{background:var(--success); color:white;}
    .btn-success:hover{filter:brightness(.95);}
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .meta{
      margin-top:10px; display:flex; justify-content:space-between; gap:10px;
      color:var(--muted); font-size:12px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--text);
      font-size:12px; border:1px solid rgba(255,255,255,.06);
    }
    .status{
      margin-top:16px; padding:14px; border-radius:12px;
      background:var(--soft);
      border:1px solid rgba(255,255,255,.06);
    }
    .status.error{
      background:var(--dangerBg);
      color:var(--danger);
      border-color: rgba(255, 107, 129, .22);
    }
    .status pre{
      margin:0; white-space:pre-wrap; word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .small{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.4}
    .footer{
      padding:16px 22px; border-top:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
      color:var(--muted); font-size:12px;
    }
    a{color:var(--primary); text-decoration:none}
    a:hover{text-decoration:underline}

    /* spinner */
    .spinner{
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      border-top-color: rgba(255,255,255,1);
      animation: spin 0.8s linear infinite;
      display:inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hintRow{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .select{
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:transparent; color:var(--text);
      font-weight:650; font-size:13px;
      cursor:pointer;
    }
  </style>
<link rel="icon" type="image/png" href="favicon.png">
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="headLeft">
  <div class="brand">
    <img src="logo-keyzone.png" alt="KeyZone Logo" class="logo" />
    <div>
      <h1 class="brandName">KeyZone</h1>
      <div class="brandTag">Retrieve your CID instantly</div>
    </div>
  </div>
</div>


        <div class="headRight">
          <select id="groupSelect" class="select" title="Grouping size">
            <option value="6" selected>Group: 6 digits</option>
            <option value="7">Group: 7 digits</option>
          </select>
          <button id="themeBtn" class="toggle" type="button">üåô Dark</button>
        </div>
      </div>

      <div class="body">
        <label for="idInput">Enter your ID</label>
        <textarea id="idInput" placeholder="Example: 123456 789012 345678 ..."></textarea>

        <div class="row">
          <button id="getBtn" class="btn btn-primary" type="button">
            <span id="getBtnText">Get CID</span>
            <span id="getBtnSpin" style="display:none" class="spinner" aria-hidden="true"></span>
          </button>

          <button id="pasteBtn" class="btn btn-ghost" type="button">Paste</button>
          <button id="clearBtn" class="btn btn-ghost" type="button">Clear</button>
          <button id="formatBtn" class="btn btn-ghost" type="button">Auto-Format</button>
        </div>

        <!-- Cloudflare Turnstile Captcha -->
<div style="margin-top:14px;">
  <div
    class="cf-turnstile"
    data-sitekey="0x4AAAAAACZWUXSonkNYzLEv"
    data-callback="onTurnstileSuccess"
    data-expired-callback="onTurnstileExpired"
    data-error-callback="onTurnstileError"
  ></div>
</div>



        <div class="meta">
          <div class="pill" id="digitsInfo">Digits: 0</div>
          <div class="pill" id="validInfo">Status: Waiting‚Ä¶</div>
        </div>

        <div id="out" class="status" style="display:none;">
          <pre id="outText"></pre>
        </div>

        <div class="row" id="afterRow" style="display:none;">
          <button id="copyBtn" class="btn btn-success" type="button">Copy CID</button>
        </div>

        <div id="copiedMsg" class="small" style="display:none;color:#10b981;font-weight:650;margin-top:8px;">
          ‚úî CID copied to clipboard
        </div>

        <div class="small">
          Tip: Only digits are kept. Formatting groups the digits (6 or 7) for easier readability.
        </div>
      </div>

      <div class="footer">
        <div>
          <a href="privacy.html" target="_blank">Privacy</a> ¬∑
          <a href="terms.html" target="_blank">Terms</a>
        </div>
        <div><a href="#" id="healthLink">Test server</a></div>
      </div>
    </div>
  </div>

<script>
  const root = document.documentElement;

  const idInput = document.getElementById("idInput");
  const getBtn = document.getElementById("getBtn");
  const getBtnText = document.getElementById("getBtnText");
  const getBtnSpin = document.getElementById("getBtnSpin");

  const pasteBtn = document.getElementById("pasteBtn");
  const clearBtn = document.getElementById("clearBtn");
  const formatBtn = document.getElementById("formatBtn");

  const digitsInfo = document.getElementById("digitsInfo");
  const validInfo = document.getElementById("validInfo");

  const out = document.getElementById("out");
  const outText = document.getElementById("outText");
  const copyBtn = document.getElementById("copyBtn");
  const afterRow = document.getElementById("afterRow");
  const copiedMsg = document.getElementById("copiedMsg");
  const healthLink = document.getElementById("healthLink");

  const themeBtn = document.getElementById("themeBtn");
  const groupSelect = document.getElementById("groupSelect");

  let currentCID = "";

  function onlyDigits(v){
    return v.replace(/[^\d]/g, "");
  }

  function groupDigits(digits, groupSize){
    if(!digits) return "";
    const re = new RegExp(`.{1,${groupSize}}`, "g");
    return digits.match(re).join(" ");
  }

  function sanitizeAndFormat(raw){
    const digits = onlyDigits(raw);
    const g = Number(groupSelect.value || 6);
    return groupDigits(digits, g);
  }

  function digitsCountFromFormatted(v){
    return onlyDigits(v).length;
  }

  function setStatus(text, ok=null){
    if(ok === true) validInfo.textContent = "Status: Ready ‚úÖ";
    else if(ok === false) validInfo.textContent = "Status: Invalid ‚ùå";
    else validInfo.textContent = "Status: " + text;
  }

  function showBox(message, isError=false){
    out.style.display = "block";
    out.className = "status" + (isError ? " error" : "");
    outText.textContent = message;
  }

  function resetResult(){
    currentCID = "";
    afterRow.style.display = "none";
    copiedMsg.style.display = "none";
    out.style.display = "none";
  }

  function setLoading(isLoading){
    getBtn.disabled = isLoading;
    getBtnText.textContent = isLoading ? "Processing‚Ä¶" : "Get CID";
    getBtnSpin.style.display = isLoading ? "inline-block" : "none";
  }

  function applyValidation(){
    const d = digitsCountFromFormatted(idInput.value);
    digitsInfo.textContent = "Digits: " + d;

    if(d === 0) setStatus("Waiting‚Ä¶", null);
    else if(d < 6) setStatus("Too short", false);
    else setStatus("Ready", true);
  }

  // Theme
  function setTheme(theme){
    if(theme === "dark"){
      root.setAttribute("data-theme", "dark");
      themeBtn.textContent = "‚òÄÔ∏è Light";
      localStorage.setItem("theme", "dark");
    } else {
      root.removeAttribute("data-theme");
      themeBtn.textContent = "üåô Dark";
      localStorage.setItem("theme", "light");
    }
  }
  themeBtn.addEventListener("click", () => {
    const isDark = root.getAttribute("data-theme") === "dark";
    setTheme(isDark ? "light" : "dark");
  });

  // Load saved theme
  const savedTheme = localStorage.getItem("theme") || "light";
  setTheme(savedTheme);

  // Group setting saved
  const savedGroup = localStorage.getItem("groupSize");
  if(savedGroup === "7") groupSelect.value = "7";
  groupSelect.addEventListener("change", () => {
    localStorage.setItem("groupSize", groupSelect.value);
    // reformat existing input
    idInput.value = sanitizeAndFormat(idInput.value);
    applyValidation();
    resetResult();
  });

  // Input formatting: keep digits and auto-group on blur (not on every keystroke to avoid cursor jumps)
  idInput.addEventListener("input", () => {
    // keep only digits/spaces while typing (soft)
    const digits = onlyDigits(idInput.value);
    // show as-is while typing, but remove letters instantly:
    const cleaned = digits ? groupDigits(digits, Number(groupSelect.value || 6)) : "";
    idInput.value = cleaned;

    applyValidation();
    resetResult();
  });

  formatBtn.addEventListener("click", () => {
    idInput.value = sanitizeAndFormat(idInput.value);
    applyValidation();
    resetResult();
  });

  pasteBtn.addEventListener("click", async () => {
    try{
      const txt = await navigator.clipboard.readText();
      idInput.value = sanitizeAndFormat(txt);
      applyValidation();
      resetResult();
    } catch {
      showBox("Paste failed. Please paste manually (Ctrl+V).", true);
    }
  });

  clearBtn.addEventListener("click", () => {
    idInput.value = "";
    applyValidation();
    resetResult();
  });
let tsToken = "";

window.onTurnstileSuccess = (token) => {
  tsToken = token;
  // ÿßÿÆÿ™Ÿäÿßÿ±Ÿä: ÿ™ÿ®ÿØŸëŸÑ status
  // setStatus("Captcha OK ‚úÖ", true);
};

window.onTurnstileExpired = () => {
  tsToken = "";
  // setStatus("Captcha expired", null);
};

window.onTurnstileError = () => {
  tsToken = "";
  // setStatus("Captcha error", null);
};

  getBtn.addEventListener("click", async () => {
  copiedMsg.style.display = "none";
  const formatted = idInput.value;
  const digits = onlyDigits(formatted);
  const d = digits.length;

  if (!digits || d < 6) {
    showBox("Please enter a valid ID (at least 6 digits).", true);
    return;
  }

  setLoading(true);
  showBox("Please wait‚Ä¶");

  // üîê Get Turnstile token
  const tsToken = document.querySelector(
    'input[name="cf-turnstile-response"]'
  )?.value;

  if (!tsToken) {
    setLoading(false);
    showBox("Please complete the captcha first.", true);
    return;
  }

  try {
    const res = await fetch("/api/get-cid", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: digits, tsToken }),
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      showBox(data.error || "Request failed.", true);
      return;
    }

    if (!data.cid) {
      showBox("CID not found in API response.", true);
      return;
    }

    currentCID = String(data.cid);
    showBox("CID: " + currentCID);
    afterRow.style.display = "flex";
  } catch (e) {
    showBox("Request failed. Please try again in a moment.", true);

  } finally {
    setLoading(false);
    if (window.turnstile) window.turnstile.reset();
  }
});


  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(currentCID);
      copiedMsg.style.display = "block";
      setTimeout(()=> copiedMsg.style.display = "none", 2000);
    } catch {
      alert("Copy failed. Please copy manually.");
    }
  });

  healthLink.addEventListener("click", async (e) => {
    e.preventDefault();
    try{
      const res = await fetch("/api/get-cid", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({})
      });
      if(res.status === 400) showBox("‚úÖ Server is reachable (API endpoint responded).");
      else showBox("Server responded, status: " + res.status);
    } catch {
      showBox("‚ùå Server is not reachable. Start it with: node server.js", true);
    }
  });

  // init
  idInput.value = sanitizeAndFormat(idInput.value);
  applyValidation();
</script>
</body>
</html>
